<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Post - Personal Blog</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans&display=swap" rel="stylesheet">
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- Local Markdown parser -->
<script src="simple-markdown.js"></script>
    <!-- MathJax for LaTeX math rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="deepmind-background">
    <header>
        <div class="container">
            <h1>My Personal Blog</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="blog.html" class="active">Blog</a></li>
                    <li><a href="resume.html">Resume(EN)</a></li>
                    <li><a href="resume-cn.html">简历(CN)</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <main>
        <section class="blog-post-section deepmind-section">
            <div class="container">
                <article class="blog-post">
                    <h2 id="post-title"></h2>
                    <div class="post-meta" id="post-meta"></div>
                    <div class="post-content" id="post-content"></div>
                    
                    <!-- Image Upload for Editing -->
                    <div id="edit-image-upload" style="display: none;">
                        <div class="form-group">
                            <label for="edit-post-image">Upload Image</label>
                            <div class="image-upload-input" id="edit-image-upload-area">
                                <span>Click or drag image here</span>
                                <input type="file" id="edit-post-image" name="edit-post-image" accept="image/*">
                            </div>
                            <div class="image-upload-preview" id="edit-image-preview" style="display: none;"></div>
                        </div>
                        <button id="insert-image-btn" class="submit-btn" style="margin-top: 1rem;">Insert Image to Content</button>
                    </div>
                    
                    <button id="edit-post-btn" class="submit-btn" style="display: none;">Edit Post</button>
                    <button id="delete-post-btn" class="submit-btn" style="background-color: #dc3545; display: none;">Delete Post</button>
                </article>
                
                <!-- Password Authentication Modal -->
                <div id="auth-modal" class="auth-modal">
                    <div class="auth-modal-content">
                        <h3>Enter Password to Edit</h3>
                        <input type="password" id="password-input" placeholder="Enter password">
                        <button onclick="verifyPassword()">Submit</button>
                        <button class="cancel" onclick="cancelEditMode()">Cancel</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <div class="container">
            <p>&copy; 2023 My Personal Blog. All rights reserved.</p>
        </div>
    </footer>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');
            let currentPost = null;

            if (postId) {
                loadBlogPost(postId);
            }

            // Function to process Obsidian-style image references
            function processObsidianImages(content) {
                // Replace Obsidian-style image references ![[filename]] with standard markdown ![](img/filename)
                return content.replace(/!\[\[([^\]]+)\]\]/g, function(match, filename) {
                    // Check if the filename already has an extension, if not assume it's an image
                    const hasExtension = /\.[a-zA-Z0-9]+$/.test(filename);
                    if (hasExtension) {
                        return `![${filename}](img/${filename})`;
                    } else {
                        // If no extension, try common image extensions
                        return `![${filename}](img/${filename})`;
                    }
                });
            }

            async function loadBlogPost(id) {
                try {
                    const response = await fetch('posts.json');
                    if (!response.ok) throw new Error('Failed to load posts.json');
                    const posts = await response.json();
                    const post = posts.find(p => p.id == id);

                    if (post) {
                        currentPost = post;
                        document.getElementById('post-title').textContent = post.title;
                        document.getElementById('post-meta').textContent = `Published on ${new Date(post.date).toLocaleDateString()}`;
                        const contentDiv = document.getElementById('post-content');
                        // Process Obsidian-style image references before parsing markdown
                        const processedContent = processObsidianImages(post.content);
                        contentDiv.innerHTML = marked.parse(processedContent);
                        contentDiv.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                        
                        // Render MathJax equations after content is loaded
                        if (window.MathJax) {
                            MathJax.typesetPromise([contentDiv]).catch(function (err) {
                                console.log('MathJax typeset error:', err);
                            });
                        }

                        document.getElementById('edit-post-btn').style.display = 'inline-block';
                        document.getElementById('delete-post-btn').style.display = 'inline-block';
                    } else {
                        document.getElementById('post-title').textContent = 'Post not found';
                    }
                } catch (error) {
                    console.error('Error loading post:', error);
                    document.getElementById('post-title').textContent = 'Error loading post';
                }
            }

            document.getElementById('edit-post-btn').addEventListener('click', () => {
                showAuthModal();
                window.verifyPassword = function() {
                    const passwordInput = document.getElementById('password-input');
                    if (passwordInput.value === 'ZBS88888888') {
                        cancelEditMode(); // Close modal
                        enterEditMode();
                    } else {
                        alert('Incorrect password.');
                    }
                }
            });

            document.getElementById('delete-post-btn').addEventListener('click', () => {
                showAuthModal();
                window.verifyPassword = function() {
                    const passwordInput = document.getElementById('password-input');
                    if (passwordInput.value === 'ZBS88888888') {
                        cancelEditMode(); // Close modal
                        deletePostFlow(currentPost.id);
                    } else {
                        alert('Incorrect password.');
                    }
                }
            });

            function enterEditMode() {
                if (!currentPost) return;

                document.getElementById('post-title').contentEditable = true;
                document.getElementById('post-content').contentEditable = true;
                document.getElementById('post-title').classList.add('editing');
                document.getElementById('post-content').classList.add('editing');
                document.getElementById('edit-post-btn').textContent = 'Save Changes';
                document.getElementById('edit-post-btn').onclick = savePostFlow;
            }

            async function savePostFlow() {
                if (!currentPost) return;

                const updatedTitle = document.getElementById('post-title').textContent;
                const updatedContent = document.getElementById('post-content').innerText; // Use innerText to get raw text

                try {
                    const response = await fetch('posts.json');
                    const posts = await response.json();
                    const postIndex = posts.findIndex(p => p.id == currentPost.id);

                    if (postIndex > -1) {
                        posts[postIndex].title = updatedTitle;
                        posts[postIndex].content = updatedContent;
                        posts[postIndex].date = new Date().toISOString();

                        const instruction = `To update this post, replace the entire content of your posts.json file with the following:\n\n${JSON.stringify(posts, null, 2)}`;
                        showInstructions('Update Post', instruction);
                        exitEditMode();
                    }
                } catch (error) {
                    console.error('Failed to save post:', error);
                    alert('Could not load posts.json to save changes.');
                }
            }

            async function deletePostFlow(id) {
                if (confirm('Are you sure you want to delete this post?')) {
                    try {
                        const response = await fetch('posts.json');
                        const posts = await response.json();
                        const updatedPosts = posts.filter(post => post.id != id);

                        const instruction = `To delete the post, replace the entire content of your posts.json file with the following:\n\n${JSON.stringify(updatedPosts, null, 2)}`;
                        showInstructions('Delete Post', instruction);
                        // Visually remove post and redirect
                        document.querySelector('.blog-post-section').innerHTML = '<h2>Post has been marked for deletion. Update posts.json to finalize.</h2>';
                        setTimeout(() => window.location.href = 'blog.html', 3000);
                    } catch (error) {
                        console.error('Failed to process post deletion:', error);
                        alert('Could not load posts.json to perform deletion.');
                    }
                }
            }

            function exitEditMode() {
                document.getElementById('post-title').contentEditable = false;
                document.getElementById('post-content').contentEditable = false;
                document.getElementById('post-title').classList.remove('editing');
                document.getElementById('post-content').classList.remove('editing');
                document.getElementById('edit-post-btn').textContent = 'Edit Post';
                document.getElementById('edit-post-btn').onclick = () => {
                    showAuthModal();
                    window.verifyPassword = function() {
                        const passwordInput = document.getElementById('password-input');
                        if (passwordInput.value === 'ZBS88888888') {
                            cancelEditMode();
                            enterEditMode();
                        } else {
                            alert('Incorrect password.');
                        }
                    }
                };
            }
        });
    </script>
</body>
</html>